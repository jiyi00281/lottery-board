<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>波场极速彩 - 集成预测投票系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2>波场极速彩 - 集成预测投票系统</h2>

    <div class="alert alert-success mt-3" id="status">数据初始化中...</div>

    <div class="p-4 bg-info text-white rounded">
      <p><strong>预测数字：</strong><span id="predict-number">--</span></p>
      <p><strong>命中率估算：</strong><span id="hit-rate">--%</span></p>
      <p><strong>投票支持：</strong><span id="vote-summary">--</span></p>
      <p><strong>分析说明：</strong><span id="predict-reason">--</span></p>
    </div>

    <h5 class="mt-4">预测命中记录</h5>
    <ul id="hit-list" class="list-group mb-4"></ul>

    <h5>开奖记录</h5>
    <table class="table table-striped">
      <thead><tr><th>期号</th><th>开奖号码</th><th>开奖时间</th></tr></thead>
      <tbody id="lottery-body"></tbody>
    </table>
  </div>

  <script>
    const API_URL = 'https://api.duoqu.online/data?code=Tron-Fast&limit=30&key=rkjpugmlzj';
    let predictions = [];
    let lastBetNo = null;

    function frequencyModel(numbers) {
      const freq = Array(10).fill(0);
      numbers.flat().forEach(n => freq[n]++);
      return freq.indexOf(Math.max(...freq));
    }

    function coldHotModel(numbers, recent = 10) {
      const flat = numbers.slice(0, recent).flat();
      const missing = Array(10).fill(0).map((_, i) => ({
        n: i,
        lastSeen: flat.lastIndexOf(i)
      }));
      return missing.sort((a, b) => a.lastSeen - b.lastSeen)[0].n;
    }

    function annealingModel(numbers) {
      const freq = Array(10).fill(0);
      numbers.flat().forEach(n => freq[n]++);
      let current = Math.floor(Math.random() * 10);
      let best = current, bestScore = freq[current], temp = 50;

      for (let i = 0; i < 100; i++) {
        const next = Math.floor(Math.random() * 10);
        const delta = freq[next] - freq[current];
        if (delta > 0 || Math.exp(delta / temp) > Math.random()) {
          current = next;
          if (freq[current] > bestScore) {
            best = current;
            bestScore = freq[current];
          }
        }
        temp *= 0.95;
      }
      return best;
    }

    function getVoteResult(votes) {
      const tally = {};
      votes.forEach(n => tally[n] = (tally[n] || 0) + 1);
      const sorted = Object.entries(tally).sort((a, b) => b[1] - a[1]);
      return {
        number: parseInt(sorted[0][0]),
        detail: sorted.map(e => `${e[0]}(${e[1]}票)`).join(' ')
      };
    }

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        const { data } = await res.json();
        if (!data || !Array.isArray(data)) throw new Error("数据无效");

        document.getElementById("status").innerText = "数据更新成功";

        const body = document.getElementById("lottery-body");
        body.innerHTML = '';
        data.forEach(d => {
          const row = `<tr><td>${d.betNo}</td><td>${d.openNumber}</td><td>${d.openTime}</td></tr>`;
          body.innerHTML += row;
        });

        const latest = data[0];
        const numbers = data.map(d => d.openNumber.split(',').map(Number));

        if (latest.betNo !== lastBetNo) {
          lastBetNo = latest.betNo;

          const vote = [
            frequencyModel(numbers),
            annealingModel(numbers),
            coldHotModel(numbers)
          ];
          const result = getVoteResult(vote);

          const hit = latest.openNumber.split(',').includes(result.number.toString());
          predictions.unshift({ betNo: latest.betNo, number: result.number, hit: hit, detail: result.detail });
          if (predictions.length > 10) predictions.pop();

          renderPredict(result.number, result.detail);
        }

        renderHits();
      } catch (err) {
        document.getElementById("status").innerText = "更新失败：" + err.message;
        console.error(err);
      }
    }

    function renderPredict(num, detail) {
      document.getElementById("predict-number").innerText = num;
      document.getElementById("vote-summary").innerText = detail;
      document.getElementById("predict-reason").innerText = "3种模型投票决定，综合频率/冷号/退火分布";
      const rate = predictions.filter(p => p.hit).length / predictions.length * 100;
      document.getElementById("hit-rate").innerText = rate.toFixed(2);
    }

    function renderHits() {
      const ul = document.getElementById("hit-list");
      ul.innerHTML = '';
      predictions.forEach(p => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `预测期号 ${p.betNo} - 数字 ${p.number} - <span class="fw-bold text-${p.hit ? 'success' : 'danger'}">${p.hit ? '命中' : '未中'}</span>`;
        ul.appendChild(li);
      });
    }

    fetchData();
    setInterval(fetchData, 3000);
  </script>
</body>
</html>
